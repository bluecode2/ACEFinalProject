<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL MAP 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="project">
	<select id="getAllProject" parameterClass="java.util.Map"
		resultClass="project.ProjectBean">
		SELECT * from (
		    SELECT us.*, ROWNUM rnum from(
		    	SELECT 
		    	PROJECT_ID AS projectId,
		    	UPDATED_BY AS updatedBy,
		    	DEPT_ID AS dept_id,
		    	EMPLOYEE_ID AS employeeId,
		    	CREATED_BY AS createdBy,
		    	PROJECT_CODE AS projectCode,
		    	PROJECT_NAME AS projectName,
		    	PROJECT_DESC AS projectDesc,
		    	TO_CHAR(EST_START_DATE,'yyyy-MM-dd') AS estStartDateInString,
		    	TO_CHAR(EST_END_DATE,'yyyy-MM-dd') AS estEndDateInString,
		    	TO_CHAR(ACT_START_DATE,'yyyy-MM-dd') AS actStartDateInString,
		    	TO_CHAR(ACT_END_DATE,'yyyy-MM-dd') AS actEndDateInString,
		    	EST_MAIN_DAYS AS estMainDays,
		    	ACT_MAIN_DAYS AS actMainDays,
		    	PROJECT_STATUS AS projectStatus,
		    	PROJECT_PROGRESS AS projectProgress,
		    	REMARKS AS remarks,
		    	TO_CHAR(CREATE_DATE,'yyyy-MM-dd') AS createDateInString,
		    	TO_CHAR(UPDATE_DATE,'yyyy-MM-dd') AS updateDateInString,
		    	EMPLOYEE_NAME AS employeeName,
		    	DEPT_NAME AS deptName,
		    	STATUS_CAPTION AS statusCaption
		    	FROM VPROJECT
		    where 1 = 1
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectCode">
				LOWER(PROJECT_CODE) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectName">
				LOWER(PROJECT_NAME) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
      	 		order by PROJECT_ID) us 
	       WHERE ROWNUM &lt; = #end#)
        WHERE rnum &gt; #begin#
	</select>
	
	<select id="countProject" resultClass="java.lang.Integer"
		parameterClass="java.util.Map">
		SELECT COUNT(1) FROM vproject
		WHERE 1 = 1
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectCode">
				LOWER(PROJECT_CODE) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectName">
				LOWER(PROJECT_NAME)
				LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
	</select>
	
	<select id="getProjectbyId" parameterClass="java.lang.Integer" resultClass="project.ProjectBean">
		SELECT 
		    	PROJECT_ID AS projectId,
		    	UPDATED_BY AS updatedBy,
		    	DEPT_ID AS dept_id,
		    	EMPLOYEE_ID AS employeeId,
		    	CREATED_BY AS createdBy,
		    	PROJECT_CODE AS projectCode,
		    	PROJECT_NAME AS projectName,
		    	PROJECT_DESC AS projectDesc,
		    	TO_CHAR(EST_START_DATE,'yyyy-MM-dd') AS estStartDateInString,
		    	TO_CHAR(EST_END_DATE,'yyyy-MM-dd') AS estEndDateInString,
		    	TO_CHAR(ACT_START_DATE,'yyyy-MM-dd') AS actStartDateInString,
		    	TO_CHAR(ACT_END_DATE,'yyyy-MM-dd') AS actEndDateInString,
		    	EST_MAIN_DAYS AS estMainDays,
		    	ACT_MAIN_DAYS AS actMainDays,
		    	PROJECT_STATUS AS projectStatus,
		    	PROJECT_PROGRESS AS projectProgress,
		    	REMARKS AS remarks,
		    	TO_CHAR(CREATE_DATE,'yyyy-MM-dd') AS createDateInString,
		    	TO_CHAR(UPDATE_DATE,'yyyy-MM-dd') AS updateDateInString,
		    	EMPLOYEE_NAME AS employeeName,
		    	DEPT_NAME AS deptName,
		    	STATUS_CAPTION AS statusCaption
		    	FROM VPROJECT
		    where PROJECT_ID = #tempProjectID#
	</select>
	
	<select id="getNewProjectId" resultClass="java.lang.Integer">
		SELECT MAX(PROJECT_ID)+1 FROM VPROJECT
	</select>
	
	<insert id="insertProject" parameterClass="project.ProjectBean">
		insert into project 
		(project_id, 
		dept_id, employee_id, 
		created_by,project_code, 
		project_name, project_desc, 
		est_start_date, est_end_date, 	
		est_main_days, 
		project_status, 
		 create_date) values
		(#projectId#,
		#dept_id#,#employeeId#,
		#createdBy#,#projectCode#,
		#projectName#,#projectDesc#,
		TO_DATE(#estStartDateInString#,'yyyy-MM-dd'),TO_DATE(#estEndDateInString#,'yyyy-MM-dd'),
		#estMainDays#,
		'PR_STAT_01',
		SYSDATE)
	</insert>
	
	<update id="updateProject" parameterClass="project.ProjectBean">
		update project set
			PROJECT_NAME = #projectName#,
			PROJECT_DESC = #projectDesc#,
			EMPLOYEE_ID = #employeeId#,
			DEPT_ID = #dept_id#,
			EST_START_DATE = TO_DATE(#estStartDateInString#,'yyyy-MM-dd'),
			EST_END_DATE = TO_DATE(#estEndDateInString#,'yyyy-MM-dd'),
			REMARKS = #remarks#,
			UPDATED_BY = #updatedBy#,
			UPDATE_DATE = SYSDATE,
			est_main_days = #estMainDays#,
			project_status = #projectStatus#,
			PROJECT_PROGRESS = #projectProgress#,
			act_start_date = TO_DATE(#actStartDateInString#,'yyyy-MM-dd'),
			act_end_date = TO_DATE(#actEndDateInString#,'yyyy-MM-dd'),
			act_main_days = #actMainDays#
			WHERE PROJECT_ID = 	#projectId#		
	</update>

	<select id="getProjectInvolved" parameterClass="java.util.Map"
		resultClass="project.ProjectBean">
		SELECT * from (
            SELECT us.*, ROWNUM rnum from(
                SELECT 
                P.PROJECT_ID AS projectId,
                P.UPDATED_BY AS updatedBy,
                P.DEPT_ID AS dept_id,
                P.EMPLOYEE_ID AS employeeId,
                P.CREATED_BY AS createdBy,
                P.PROJECT_CODE AS projectCode,
                P.PROJECT_NAME AS projectName,
                P.PROJECT_DESC AS projectDesc,
                TO_CHAR(P.EST_START_DATE,'yyyy-MM-dd') AS estStartDateInString,
                TO_CHAR(P.EST_END_DATE,'yyyy-MM-dd') AS estEndDateInString,
                TO_CHAR(P.ACT_START_DATE,'yyyy-MM-dd') AS actStartDateInString,
                TO_CHAR(P.ACT_END_DATE,'yyyy-MM-dd') AS actEndDateInString,
                P.EST_MAIN_DAYS AS estMainDays,
                P.ACT_MAIN_DAYS AS actMainDays,
                P.PROJECT_STATUS AS projectStatus,
                P.PROJECT_PROGRESS AS projectProgress,
                P.REMARKS AS remarks,
                TO_CHAR(P.CREATE_DATE,'yyyy-MM-dd') AS createDateInString,
                TO_CHAR(P.UPDATE_DATE,'yyyy-MM-dd') AS updateDateInString,
                P.EMPLOYEE_NAME AS employeeName,
                P.DEPT_NAME AS deptName,
                P.STATUS_CAPTION AS statusCaption
                FROM VPROJECT P JOIN PROJECT_MEMBER PM
                ON P.PROJECT_ID=PM.PROJECT_ID
                where PM.EMPLOYEE_ID = (SELECT E.EMPLOYEE_ID FROM EMPLOYEE E JOIN USERS S ON E.EMPLOYEE_ID = S.EMPLOYEE_ID WHERE S.USER_ID=#employeeId#)
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectCode">
				LOWER(P.PROJECT_CODE) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectName">
				LOWER(P.PROJECT_NAME) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
      	 		order by P.PROJECT_ID) us 
	       WHERE ROWNUM &lt; = #end#)
        WHERE rnum &gt; #begin#
	</select>
	<select id="getAllProjectToEvaluate" parameterClass="java.util.Map"
		resultClass="project.ProjectBean">
		SELECT * from (
		    SELECT us.*, ROWNUM rnum from(
		    	SELECT 
		    	PROJECT_ID AS projectId,
		    	UPDATED_BY AS updatedBy,
		    	DEPT_ID AS dept_id,
		    	EMPLOYEE_ID AS employeeId,
		    	CREATED_BY AS createdBy,
		    	PROJECT_CODE AS projectCode,
		    	PROJECT_NAME AS projectName,
		    	PROJECT_DESC AS projectDesc,
		    	TO_CHAR(EST_START_DATE,'yyyy-MM-dd') AS estStartDateInString,
		    	TO_CHAR(EST_END_DATE,'yyyy-MM-dd') AS estEndDateInString,
		    	TO_CHAR(ACT_START_DATE,'yyyy-MM-dd') AS actStartDateInString,
		    	TO_CHAR(ACT_END_DATE,'yyyy-MM-dd') AS actEndDateInString,
		    	EST_MAIN_DAYS AS estMainDays,
		    	ACT_MAIN_DAYS AS actMainDays,
		    	PROJECT_STATUS AS projectStatus,
		    	PROJECT_PROGRESS AS projectProgress,
		    	REMARKS AS remarks,
		    	TO_CHAR(CREATE_DATE,'yyyy-MM-dd') AS createDateInString,
		    	TO_CHAR(UPDATE_DATE,'yyyy-MM-dd') AS updateDateInString,
		    	EMPLOYEE_NAME AS employeeName,
		    	DEPT_NAME AS deptName,
		    	STATUS_CAPTION AS statusCaption
		    	FROM VPROJECT
		   		where project_status = #projectStatus# and dept_id = #deptId#
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectCode">
				LOWER(PROJECT_CODE) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectName">
				LOWER(PROJECT_NAME) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
      	 		order by PROJECT_ID) us 
	       WHERE ROWNUM &lt; = #end#)
        WHERE rnum &gt; #begin#
	</select>
	
	<select id="countProjectToEvaluate" resultClass="java.lang.Integer"
		parameterClass="java.util.Map">
		SELECT COUNT(1) FROM vproject
		where project_status = #projectStatus# and dept_id = #deptId#
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectCode">
				LOWER(PROJECT_CODE) LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
		<dynamic prepend="AND">
			<isEqual property="searchField" compareValue="projectName">
				LOWER(PROJECT_NAME)
				LIKE LOWER( '%' || #searchValue# || '%' )
			</isEqual>
		</dynamic>
	</select>
</sqlMap>